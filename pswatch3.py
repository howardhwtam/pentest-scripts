import argparse
import platform
import subprocess
import sys
import time


def run_ps(ignored_keywords):
    c = "cmd"
    if platform.system() == "Darwin":
        c = "command"

    if ignored_keywords != None:
        ik = ignored_keywords.replace(",", "|")
        grep_cmd = "ps -eo user,%s|grep -Ev '%s'" % (c, ik)
    else:
        grep_cmd = "ps -eo user,%s" % c
    
    op = subprocess.check_output(grep_cmd, shell=True)
    return op.decode().split("\n")


def main():
    parser = argparse.ArgumentParser(description="Logging new processes")
    parser.add_argument("-i", dest="keywords", help="Keywords to ignore. Ex: -i kworker,www-data")
    args = parser.parse_args()

    baseline_arr = run_ps(args.keywords)
    print("\n[+] New process(es):")
    try:
        while True:
            new_arr = run_ps(args.keywords)
            new_ps = list(set(new_arr) - set(baseline_arr))
            if new_ps:
                for i in new_ps:
                    print(time.strftime("[%H:%M:%S] ", time.localtime()) + i)
                    baseline_arr = new_arr
    except KeyboardInterrupt:
        print("\n\n[-] Exiting...\n")
        sys.exit(0)


main()

